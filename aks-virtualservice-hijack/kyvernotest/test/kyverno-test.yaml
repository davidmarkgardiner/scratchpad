apiVersion: cli.kyverno.io/v1alpha1
kind: Test
metadata:
  name: hostname-policies-test
policies:
  - ../prevent-httproute-hostname-hijack.yaml
  - ../prevent-vs-hostname-hijack.yaml
  - ../mutate-httproute-hostname.yaml
  - ../mutate-vs-hostname.yaml
resources:
  - resources.yaml
results:
  # HTTPRoute Tests
  - policy: prevent-httproute-hostname-hijack
    rule: enforce-namespace-hostname
    resources:
      - test-route
    kind: HTTPRoute
    namespace: app1
    result: pass

  - policy: prevent-httproute-hostname-hijack
    rule: enforce-namespace-hostname
    resources:
      - bad-route
    kind: HTTPRoute
    namespace: app2
    result: fail

  # VirtualService Tests
  - policy: prevent-vs-hostname-hijack
    rule: enforce-namespace-hostname
    resources:
      - test-vs
    kind: VirtualService
    namespace: app1
    result: pass

  - policy: prevent-vs-hostname-hijack
    rule: enforce-namespace-hostname
    resources:
      - bad-vs
    kind: VirtualService
    namespace: app2
    result: fail

  # HTTPRoute Mutation Tests
  - policy: mutate-httproute-hostname
    rule: prepend-namespace-to-hostname
    resources:
      - test-route
    kind: HTTPRoute
    namespace: test-ns
    result: pass
    patchedResource:
      spec:
        hostnames:
          - "test-ns-example.com"
          - "test-ns-api.example.com"

  # VirtualService Mutation Tests
  - policy: mutate-vs-hostname
    rule: prepend-namespace-to-hostname
    resources:
      - test-vs
    kind: VirtualService
    namespace: test-ns
    result: pass
    patchedResource:
      spec:
        hosts:
          - "test-ns-example.com"
          - "test-ns-api.example.com"